{% extends 'layouts/base.html' %} {% block title %}{{ student_file.file_name }}
- Students{% endblock %} {% block breadcrumb %}Student Files > {{
student_file.file_name }}{% endblock %} {% block content %}
<div class="page-header flex-between">
  <div>
    <h1>ğŸ‘¨â€ğŸ“ {{ student_file.file_name }}</h1>
    <p>
      {{ student_file.class_name }} | Division {{ student_file.division }} | {{
      student_file.year }} | {{ student_file.total_students }} students
    </p>
  </div>
  <div>
    <a
      href="{% url 'file_download' file_id=student_file.pk %}"
      class="btn btn-success btn-sm"
      >ğŸ“¥ Download Excel</a
    >
    <a href="{% url 'file_list' %}" class="btn btn-secondary btn-sm">â† Back</a>
  </div>
</div>

<div class="card">
  <form method="GET" class="search-bar">
    <input
      type="text"
      name="search"
      placeholder="Search by name, roll, PRN..."
      value="{{ search }}"
    />
    <button type="submit" class="btn btn-secondary btn-sm">Search</button>
  </form>

  {% if page_obj.object_list %}
  <table>
    <thead>
      <tr>
        <th>Roll</th>
        <th>PRN</th>
        <th>Name</th>
        <th>Phone</th>
        <th>Email</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for student in page_obj %}
      <tr>
        <td>{{ student.roll_no }}</td>
        <td>{{ student.prn }}</td>
        <td><strong>{{ student.full_name }}</strong></td>
        <td>{{ student.phone|default:"-" }}</td>
        <td>{{ student.email|default:"-" }}</td>
        <td>
          {% if student.status == 'normal' %}
          <span class="badge badge-success">Normal</span>
          {% elif student.status == 'marked' %}
          <span class="badge badge-warning">Edit Marked</span>
          {% elif student.status == 'resolved' %}
          <span class="badge badge-info">Resolved</span>
          {% endif %}
        </td>
        <td class="actions">
          <a
            href="{% url 'student_profile' pk=student.pk %}"
            class="btn btn-secondary btn-sm"
            >ğŸ‘</a
          >
          {% if request.user.role == 'admin' %}
          <a
            href="{% url 'student_edit' pk=student.pk %}"
            class="btn btn-warning btn-sm"
            >âœï¸</a
          >
          <form
            method="POST"
            action="{% url 'student_delete' pk=student.pk %}"
            style="display: inline"
            onsubmit="return confirm('Delete this student?');"
          >
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘</button>
          </form>
          {% elif request.user.role == 'hod' or request.user.role == 'teacher'
          or request.user.role == 'guardian' %} {% if student.status != 'marked'
          %}
          <form
            method="POST"
            action="{% url 'create_mark_edit' %}"
            style="display: inline"
          >
            {% csrf_token %}
            <input type="hidden" name="student_id" value="{{ student.pk }}" />
            <button
              type="button"
              class="btn btn-warning btn-sm"
              onclick="openMarkModal({{ student.pk }}, '{{ student.full_name }}')"
            >
              ğŸš© Mark Edit
            </button>
          </form>
          {% else %}
          <span class="badge badge-gray">âœ… Marked</span>
          {% endif %} {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if page_obj.has_other_pages %}
  <div class="pagination">
    {% if page_obj.has_previous %}<a
      href="?page={{ page_obj.previous_page_number }}&search={{ search }}"
      >â† Prev</a
    >{% endif %} {% for num in page_obj.paginator.page_range %}{% if
    page_obj.number == num %}<span class="current">{{ num }}</span>{% elif num >
    page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}<a
      href="?page={{ num }}&search={{ search }}"
      >{{ num }}</a
    >{% endif %}{% endfor %} {% if page_obj.has_next %}<a
      href="?page={{ page_obj.next_page_number }}&search={{ search }}"
      >Next â†’</a
    >{% endif %}
  </div>
  {% endif %} {% else %}
  <div class="empty-state">
    <h3>No students found</h3>
    <p>No students match your search criteria.</p>
  </div>
  {% endif %}
</div>

<!-- Mark Edit Modal -->
{% if request.user.role in 'hod,teacher,guardian' %}
<div
  id="markEditModal"
  style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 100;
    align-items: center;
    justify-content: center;
  "
>
  <div
    style="
      background: #fff;
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      margin: auto;
      margin-top: 15vh;
    "
  >
    <h3 style="margin-bottom: 20px">ğŸš© Mark Edit Request</h3>
    <p
      id="markStudentName"
      style="font-size: 14px; color: #64748b; margin-bottom: 15px"
    ></p>

    <form method="POST" action="{% url 'create_mark_edit' %}">
      {% csrf_token %}
      <input type="hidden" name="student_id" id="markStudentId" />

      <div class="form-group">
        <label>What needs editing? *</label>
        <select name="field_to_edit" class="form-input" required>
          <option value="">-- Select Field --</option>
          <option value="full_name">Full Name</option>
          <option value="phone">Phone Number</option>
          <option value="email">Email Address</option>
          <option value="parent_name">Parent Name</option>
          <option value="parent_phone">Parent Phone</option>
          <option value="address">Address</option>
          <option value="roll_no">Roll Number</option>
          <option value="prn">PRN Number</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label>Remark / Details *</label>
        <textarea
          name="remark"
          class="form-input"
          rows="3"
          placeholder="Describe what needs to be changed..."
          required
        ></textarea>
      </div>

      <div style="text-align: right; margin-top: 15px">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="closeMarkModal()"
        >
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">ğŸ“¤ Submit Request</button>
      </div>
    </form>
  </div>
</div>

<script>
  function openMarkModal(studentId, studentName) {
    document.getElementById("markStudentId").value = studentId;
    document.getElementById("markStudentName").textContent =
      "Student: " + studentName;
    document.getElementById("markEditModal").style.display = "flex";
  }
  function closeMarkModal() {
    document.getElementById("markEditModal").style.display = "none";
  }
  document
    .getElementById("markEditModal")
    .addEventListener("click", function (e) {
      if (e.target === this) closeMarkModal();
    });
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") closeMarkModal();
  });
</script>
{% endif %} {% endblock %}

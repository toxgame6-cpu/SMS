{% extends 'layouts/base.html' %} {% block title %}Reports & Analytics - SMS
Portal{% endblock %} {% block breadcrumb %}Admin > Reports & Analytics{%
endblock %} {% block content %}
<div class="page-header flex-between">
  <div>
    <h1>ğŸ“Š Reports & Analytics</h1>
    <p>Visual overview of your entire system</p>
  </div>
  <a href="{% url 'export_summary_pdf' %}" class="btn btn-primary"
    >ğŸ“„ Export Summary PDF</a
  >
</div>

<!-- Summary Cards -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="icon">ğŸ‘¨â€ğŸ“</div>
    <div class="value">{{ summary.total_students }}</div>
    <div class="label">Total Students</div>
  </div>
  <div class="stat-card">
    <div class="icon">ğŸ“</div>
    <div class="value">{{ summary.total_files }}</div>
    <div class="label">Student Files</div>
  </div>
  <div class="stat-card">
    <div class="icon">ğŸ‘¥</div>
    <div class="value">{{ summary.total_staff }}</div>
    <div class="label">Total Staff</div>
  </div>
  <div class="stat-card">
    <div class="icon">ğŸ“¢</div>
    <div class="value">{{ summary.total_announcements }}</div>
    <div class="label">Announcements</div>
  </div>
  <div class="stat-card">
    <div class="icon">ğŸ””</div>
    <div class="value">{{ summary.total_notifications }}</div>
    <div class="label">Edit Requests</div>
  </div>
  <div class="stat-card">
    <div class="icon">ğŸ“ˆ</div>
    <div class="value">{{ summary.actions_today }}</div>
    <div class="label">Actions Today</div>
  </div>
</div>

<!-- Charts Row 1 -->
<div
  style="
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  "
>
  <div class="card">
    <div class="card-header"><h3>ğŸ“ Students by Class</h3></div>
    <div style="height: 220px; position: relative">
      <canvas id="classChart"></canvas>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><h3>ğŸ“Š Students by Division</h3></div>
    <div style="height: 220px; position: relative">
      <canvas id="divisionChart"></canvas>
    </div>
  </div>
</div>

<!-- Charts Row 2 -->
<div
  style="
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  "
>
  <div class="card">
    <div class="card-header"><h3>ğŸ“… Students by Year</h3></div>
    <div style="height: 220px; position: relative">
      <canvas id="yearChart"></canvas>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><h3>ğŸ‘¥ Staff by Role</h3></div>
    <div style="height: 220px; position: relative">
      <canvas id="roleChart"></canvas>
    </div>
  </div>
</div>

<!-- Charts Row 3 -->
<div
  style="
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  "
>
  <div class="card">
    <div class="card-header"><h3>ğŸ¢ Staff by Department</h3></div>
    <div style="height: 220px; position: relative">
      <canvas id="deptChart"></canvas>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><h3>ğŸ“‹ Student Status</h3></div>
    <div style="height: 220px; position: relative">
      <canvas id="statusChart"></canvas>
    </div>
  </div>
</div>

<!-- Charts Row 4 -->
<div
  style="
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  "
>
  <div class="card">
    <div class="card-header"><h3>ğŸ“¤ Upload History (30 Days)</h3></div>
    <div style="height: 220px; position: relative">
      <canvas id="uploadChart"></canvas>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><h3>ğŸš© Most Requested Edit Fields</h3></div>
    <div style="height: 220px; position: relative">
      <canvas id="fieldChart"></canvas>
    </div>
  </div>
</div>

<!-- Notification Stats + Active Users -->
<div
  style="
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  "
>
  <div class="card">
    <div class="card-header"><h3>ğŸ”” Notification Summary</h3></div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px">
      <div
        style="
          text-align: center;
          padding: 15px;
          background: #f0f9ff;
          border-radius: 10px;
        "
      >
        <div style="font-size: 28px; font-weight: 900; color: #3b82f6">
          {{ notif_stats.total }}
        </div>
        <div style="font-size: 12px; color: #64748b; margin-top: 4px">
          Total Requests
        </div>
      </div>
      <div
        style="
          text-align: center;
          padding: 15px;
          background: #fef3c7;
          border-radius: 10px;
        "
      >
        <div style="font-size: 28px; font-weight: 900; color: #d97706">
          {{ notif_stats.pending }}
        </div>
        <div style="font-size: 12px; color: #64748b; margin-top: 4px">
          Pending
        </div>
      </div>
      <div
        style="
          text-align: center;
          padding: 15px;
          background: #dcfce7;
          border-radius: 10px;
        "
      >
        <div style="font-size: 28px; font-weight: 900; color: #16a34a">
          {{ notif_stats.resolved }}
        </div>
        <div style="font-size: 12px; color: #64748b; margin-top: 4px">
          Resolved
        </div>
      </div>
      <div
        style="
          text-align: center;
          padding: 15px;
          background: #f1f5f9;
          border-radius: 10px;
        "
      >
        <div style="font-size: 28px; font-weight: 900; color: #64748b">
          {{ notif_stats.dismissed }}
        </div>
        <div style="font-size: 12px; color: #64748b; margin-top: 4px">
          Dismissed
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h3>ğŸ† Most Active Users (30 Days)</h3></div>
    {% if active_users %}
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>User</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for u in active_users %}
        <tr>
          <td>
            {% if forloop.counter == 1 %}ğŸ¥‡{% elif forloop.counter == 2 %}ğŸ¥ˆ{%
            elif forloop.counter == 3 %}ğŸ¥‰{% else %}{{ forloop.counter }}{%
            endif %}
          </td>
          <td><strong>{{ u.user__full_name|default:"Unknown" }}</strong></td>
          <td>
            <span class="badge badge-info">{{ u.user__role|default:"" }}</span>
          </td>
          <td><strong>{{ u.action_count }}</strong></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p style="color: #94a3b8; text-align: center; padding: 20px">
      No activity data.
    </p>
    {% endif %}
  </div>
</div>

<!-- Recent Uploads Timeline -->
<div class="card">
  <div class="card-header"><h3>ğŸ“¤ Recent File Uploads</h3></div>
  {% if recent_uploads %}
  <div style="padding-left: 30px">
    {% for file in recent_uploads %}
    <div
      style="
        position: relative;
        padding-bottom: 18px;
        border-left: 2px solid #e2e8f0;
        padding-left: 20px;
        margin-left: 8px;
      "
    >
      <div
        style="position: absolute; left: -8px; top: 2px; width: 14px; height: 14px; border-radius: 50%; background: {% if forloop.first %}#4f46e5{% else %}#94a3b8{% endif %}; border: 2px solid #fff;"
      ></div>
      <div style="font-size: 12px; color: #94a3b8">
        {{ file.upload_date|date:"d M Y, h:i A" }}
      </div>
      <div style="font-size: 14px; font-weight: 600">
        ğŸ“ {{ file.file_name }}
      </div>
      <div style="font-size: 13px; color: #64748b; margin-top: 2px">
        {{ file.class_name }} | Div {{ file.division }} | {{ file.year }} |
        <span class="badge badge-info">{{ file.total_students }} students</span>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p style="color: #94a3b8; text-align: center; padding: 20px">
    No files uploaded yet.
  </p>
  {% endif %}
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  // Disable animations to prevent lag
  Chart.defaults.animation = false;
  Chart.defaults.responsive = true;
  Chart.defaults.maintainAspectRatio = false;

  const colors = ['#6366f1', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#14b8a6'];
  const bgColors = ['rgba(99,102,241,0.7)', 'rgba(139,92,246,0.7)', 'rgba(6,182,212,0.7)', 'rgba(16,185,129,0.7)', 'rgba(245,158,11,0.7)', 'rgba(239,68,68,0.7)', 'rgba(236,72,153,0.7)', 'rgba(20,184,166,0.7)'];

  var legendOpts = { position: 'bottom', labels: { padding: 10, usePointStyle: true, font: { size: 11 } } };

  // 1. Class-wise Bar
  new Chart(document.getElementById('classChart'), {
      type: 'bar',
      data: { labels: {{ class_labels|safe }}, datasets: [{ label: 'Students', data: {{ class_data|safe }}, backgroundColor: bgColors, borderRadius: 6 }] },
      options: { plugins: { legend: { display: false } } }
  });

  // 2. Division Doughnut
  new Chart(document.getElementById('divisionChart'), {
      type: 'doughnut',
      data: { labels: {{ division_labels|safe }}, datasets: [{ data: {{ division_data|safe }}, backgroundColor: bgColors, borderWidth: 2, borderColor: '#fff' }] },
      options: { plugins: { legend: legendOpts } }
  });

  // 3. Year Bar
  new Chart(document.getElementById('yearChart'), {
      type: 'bar',
      data: { labels: {{ year_labels|safe }}, datasets: [{ label: 'Students', data: {{ year_data|safe }}, backgroundColor: 'rgba(6,182,212,0.7)', borderRadius: 6 }] },
      options: { plugins: { legend: { display: false } } }
  });

  // 4. Role Pie
  new Chart(document.getElementById('roleChart'), {
      type: 'pie',
      data: { labels: {{ role_labels|safe }}, datasets: [{ data: {{ role_data|safe }}, backgroundColor: bgColors, borderWidth: 2, borderColor: '#fff' }] },
      options: { plugins: { legend: legendOpts } }
  });

  // 5. Department Horizontal Bar
  new Chart(document.getElementById('deptChart'), {
      type: 'bar',
      data: { labels: {{ dept_labels|safe }}, datasets: [{ label: 'Staff', data: {{ dept_data|safe }}, backgroundColor: 'rgba(139,92,246,0.7)', borderRadius: 6 }] },
      options: { indexAxis: 'y', plugins: { legend: { display: false } } }
  });

  // 6. Status Doughnut
  new Chart(document.getElementById('statusChart'), {
      type: 'doughnut',
      data: { labels: {{ status_labels|safe }}, datasets: [{ data: {{ status_data|safe }}, backgroundColor: ['rgba(22,163,74,0.7)', 'rgba(245,158,11,0.7)', 'rgba(59,130,246,0.7)'], borderWidth: 2, borderColor: '#fff' }] },
      options: { plugins: { legend: legendOpts } }
  });

  // 7. Upload Timeline
  new Chart(document.getElementById('uploadChart'), {
      type: 'line',
      data: { labels: {{ upload_dates|safe }}, datasets: [{ label: 'Files', data: {{ upload_counts|safe }}, borderColor: '#4f46e5', backgroundColor: 'rgba(79,70,229,0.1)', fill: true, tension: 0.4, pointRadius: 3 }] },
      options: { plugins: { legend: { display: false } } }
  });

  // 8. Edit Fields Bar
  new Chart(document.getElementById('fieldChart'), {
      type: 'bar',
      data: { labels: {{ field_labels|safe }}, datasets: [{ label: 'Requests', data: {{ field_data|safe }}, backgroundColor: 'rgba(239,68,68,0.7)', borderRadius: 6 }] },
      options: { plugins: { legend: { display: false } } }
  });
</script>
{% endblock %}
